<!DOCTYPE html>
<html lang="en">
<head>
    <title>Index</title>
    <meta charset="UTF-8">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        body {margin:0;padding:0}
        #editor {
            height: calc(100vh - 42px);
            width: 100%;
        }
    </style>
</head>
<body>
<div id="editor">{% csrf_token %}</div>
{% csrf_token %}
<script>
    var Delta = Quill.import('delta');
    var quill = new Quill('#editor', {
      modules: {
        toolbar: true
      },
      placeholder: 'Start typing here...',
      theme: 'snow'
    });

    // Store accumulated changes
    var change = new Delta();
    var page_id;
    quill.on('text-change', function(delta) {
      change = change.compose(delta);
      if (window.location.pathname === "/") {
          {% if data.new_id %}
          history.pushState("new-page", "Editor", "/{{ data.new_id }}");
          {% endif %}
      }
    });

    // Save periodically
    setInterval(function() {
      if (change.length() > 0) {
        {#console.log('Saving changes', change);#}
        /*
        Send partial changes
        $.post('/your-endpoint', {
          partial: JSON.stringify(change)
        });

        Send entire document
        $.post('/your-endpoint', {
          doc: JSON.stringify(quill.getContents())
        });
        */
        $.post("/save", {
            page: window.location.pathname,
            doc: JSON.stringify(quill.getContents()),
            csrfmiddlewaretoken: jQuery("[name=csrfmiddlewaretoken]").val()
        });
        change = new Delta();
      }
    }, 5*1000);

    // Check for unsaved data
    window.onbeforeunload = function() {
      if (change.length() > 0) {
        return 'There are unsaved changes. Are you sure you want to leave?';
      }
    }
</script>
{% if data.id %}
    <script>
    $.ajax("/data/{{ data.id }}")
        .done(function(data){
            quill.setContents(JSON.parse(data));
        })
        .fail(function(date){
            window.location.href = window.location.origin;
        });
    </script>
{% endif %}
</body>
</html>